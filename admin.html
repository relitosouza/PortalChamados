<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Portal de Chamados Smarapd</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
</head>

<body>
    <header>
        <div class="container">
            <h1>üõ†Ô∏è Administra√ß√£o - Portal de Chamados</h1>
            <div class="user-info">
                üë§ <span id="userName">Carregando...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="alertContainer"></div>

        <div class="admin-grid">
            <!-- Coluna Esquerda: Formul√°rio -->
            <div class="card">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Atualizar Status do Chamado
                </h2>

                <div class="form-group">
                    <label>N√∫mero do Chamado</label>
                    <input type="text" id="chamadoId" placeholder="Ex: 123" />
                </div>

                <button class="btn btn-primary" onclick="buscarChamado()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="8" cy="8" r="6"></circle>
                        <path d="M14 14l6 6"></path>
                    </svg>
                    Buscar Chamado
                </button>

                <div id="chamadoDetalhes" style="display: none; margin-top: 24px;">
                    <div class="chamado-info">
                        <h3 id="chamadoTitulo">-</h3>
                        <p><strong>Status Atual:</strong> <span id="chamadoStatusAtual">-</span></p>
                        <p><strong>Sistema:</strong> <span id="chamadoSistema">-</span></p>
                        <p><strong>Solicitante:</strong> <span id="chamadoSolicitante">-</span></p>
                    </div>

                    <div class="form-group">
                        <label>Novo Status</label>
                        <div class="status-select" id="statusSelect">
                            <div class="status-option aberto" data-status="Aberto" onclick="selecionarStatus('Aberto')">
                                ‚ö†Ô∏è Aberto
                            </div>
                            <div class="status-option andamento" data-status="Em Andamento"
                                onclick="selecionarStatus('Em Andamento')">
                                üîÑ Em Andamento
                            </div>
                            <div class="status-option resolvido" data-status="Resolvido"
                                onclick="selecionarStatus('Resolvido')">
                                ‚úÖ Resolvido
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Observa√ß√£o (opcional)</label>
                        <textarea id="observacao" rows="3"
                            placeholder="Adicione uma observa√ß√£o sobre esta mudan√ßa..."></textarea>
                    </div>

                    <button class="btn btn-success" id="btnAtualizar" onclick="atualizarStatus()" disabled>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M5 10l3 3L18 3"></path>
                        </svg>
                        Atualizar Status
                    </button>
                </div>
            </div>

            <!-- Coluna Direita: Hist√≥rico -->
            <div class="card">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    Hist√≥rico do Chamado
                </h2>

                <div id="historico">
                    <div class="alert alert-info">
                        Busque um chamado para ver o hist√≥rico
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="utils.js"></script>
    <script>
        // CONFIGURA√á√ÉO - SUBSTITUA PELA URL DO SEU APPS SCRIPT
        // ‚ö†Ô∏è IMPORTANTE: Configure a URL da sua API aqui!
        // Para obter a URL:
        // 1. V√° no Apps Script
        // 2. Clique em "Implantar" > "Nova implanta√ß√£o"
        // 3. Tipo: "Aplicativo da Web"
        // 4. Acesso: "Qualquer pessoa"
        // 5. Copie a URL e cole abaixo

        let chamadoAtual = null;
        let statusSelecionado = null;
        let dadosChamado = null;

        // Carregar informa√ß√µes do usu√°rio
        window.addEventListener('DOMContentLoaded', () => {
            carregarUsuario();
        });

        async function carregarUsuario() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'validarUsuario',
                        email: ADMIN_CONFIG.userEmail
                    })
                });

                const result = await response.json();

                if (result.success && result.data.ativo) {
                    document.getElementById('userName').textContent = result.data.nome;
                } else {
                    mostrarAlerta('Usu√°rio n√£o autorizado', 'error');
                    document.getElementById('userName').textContent = 'N√£o autorizado';
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
                document.getElementById('userName').textContent = ADMIN_CONFIG.userEmail;
            }
        }

        async function buscarChamado() {
            const id = document.getElementById('chamadoId').value.trim();

            if (!id) {
                mostrarAlerta('Digite o n√∫mero do chamado', 'error');
                return;
            }

            mostrarAlerta('Buscando chamado...', 'info');

            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();

                const chamados = parseCSV(csvText);
                const chamado = chamados.find(c => c['Numero do Chamado'] === id);

                if (chamado) {
                    dadosChamado = chamado;
                    mostrarDetalhesChamado(chamado);
                    await carregarHistorico(id);
                    limparAlerta();
                } else {
                    mostrarAlerta('Chamado n√£o encontrado', 'error');
                    document.getElementById('chamadoDetalhes').style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao buscar chamado:', error);
                mostrarAlerta('Erro ao buscar chamado: ' + error.message, 'error');
            }
        }

        function mostrarDetalhesChamado(chamado) {
            chamadoAtual = chamado['Numero do Chamado'];

            document.getElementById('chamadoTitulo').textContent = chamado['Titulo'];
            document.getElementById('chamadoStatusAtual').textContent = chamado['Status'];
            document.getElementById('chamadoSistema').textContent = chamado['Sistema'] || '-';
            document.getElementById('chamadoSolicitante').textContent = chamado['Solicitante'] || '-';

            document.getElementById('chamadoDetalhes').style.display = 'block';

            // Limpar sele√ß√£o anterior
            document.querySelectorAll('.status-option').forEach(el => el.classList.remove('selected'));
            statusSelecionado = null;
            document.getElementById('btnAtualizar').disabled = true;
        }

        function selecionarStatus(status) {
            statusSelecionado = status;

            // Atualizar UI
            document.querySelectorAll('.status-option').forEach(el => {
                el.classList.remove('selected');
            });

            document.querySelector(`[data-status="${status}"]`).classList.add('selected');
            document.getElementById('btnAtualizar').disabled = false;
        }

        async function atualizarStatus() {
            if (!chamadoAtual || !statusSelecionado) {
                mostrarAlerta('Selecione um status', 'error');
                return;
            }

            const statusAtual = dadosChamado['Status'];

            if (statusAtual === statusSelecionado) {
                mostrarAlerta('O chamado j√° est√° neste status', 'error');
                return;
            }

            const observacao = document.getElementById('observacao').value.trim();
            const btn = document.getElementById('btnAtualizar');

            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div> Atualizando...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'atualizarStatus',
                        chamadoId: chamadoAtual,
                        novoStatus: statusSelecionado,
                        usuario: ADMIN_CONFIG.userEmail,
                        observacao: observacao
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    mostrarAlerta('Status atualizado com sucesso!', 'success');
                    document.getElementById('observacao').value = '';

                    // Recarregar dados do chamado para refletir a mudan√ßa
                    setTimeout(() => {
                        buscarChamado();
                    }, 1000);
                } else {
                    throw new Error(result.message || 'Erro desconhecido ao atualizar');
                }

            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                mostrarAlerta('Erro ao atualizar: ' + error.message + ' - Verifique se a URL da API est√° correta', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 10l3 3L18 3"></path></svg> Atualizar Status';
            }
        }

        async function carregarHistorico(chamadoId) {
            const historicoDiv = document.getElementById('historico');
            historicoDiv.innerHTML = '<div class="alert alert-info">Carregando hist√≥rico...</div>';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'obterHistorico',
                        chamadoId: chamadoId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    if (result.data && result.data.length > 0) {
                        renderizarHistorico(result.data);
                    } else {
                        historicoDiv.innerHTML = '<div class="alert alert-info">Nenhum hist√≥rico encontrado para este chamado.</div>';
                    }
                } else {
                    throw new Error(result.message || 'Erro ao buscar hist√≥rico');
                }
            } catch (error) {
                historicoDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>Erro ao carregar hist√≥rico</strong><br>
                        ${escapeHTML(error.message)}<br><br>
                        <small>Verifique se:</small>
                        <ul style="margin-top: 8px; padding-left: 20px;">
                            <li>A API_URL em utils.js est√° configurada corretamente</li>
                            <li>O script est√° implantado como "Aplicativo da Web"</li>
                            <li>O acesso est√° configurado como "Qualquer pessoa"</li>
                            <li>O chamado existe na planilha</li>
                        </ul>
                    </div>
                `;
            }
        }

        function renderizarHistorico(historico) {
            const html = `
                <div class="timeline">
                    ${historico.map(item => `
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <h4>${escapeHTML(item.statusAnterior)} ‚Üí ${escapeHTML(item.statusNovo)}</h4>
                                <p>por ${escapeHTML(item.usuario)}</p>
                                ${item.observacao ? `<p><em>"${escapeHTML(item.observacao)}"</em></p>` : ''}
                                <span class="timeline-date">${escapeHTML(formatarData(item.timestamp))}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('historico').innerHTML = html;
        }

        function formatarData(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function mostrarAlerta(mensagem, tipo) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${escapeHTML(tipo)}">${escapeHTML(mensagem)}</div>`;
        }

        function limparAlerta() {
            document.getElementById('alertContainer').innerHTML = '';
        }

    </script>
</body>

</html>